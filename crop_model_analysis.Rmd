---
title: "Eco-cultural niches and the spread of farming"
author: "Nick Gauthier"
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
bibliography: bibliography.bibtex
output: 
  html_document: 
    fig_caption: yes
    highlight: zenburn
    keep_md: yes
    theme: flatly
    toc: yes
---

## Setup
Load necessary packages.
```{r messages = F, warning=F}
library(raster) # for processing of raster maps
library(tidyverse) # for data cleaning and plotting
library(mgcv) # for fitting generalized additive model 
library(gdistance) # for least cost path calculations
library(viridis) # for pretty colors
library(qgam) # for quantile regression
library(gganimate) # for animated plots
# if gganimate is not installed, run the next line:
# devtools::install_github('dgrtwo/gganimate')
# devtools::install_github("gavinsimpson/schoenberg")
library(schoenberg)
```

### Basemaps

Define our study area as the supra-mediterranean region.
```{r}
bbox <- extent(-9.9, 45, 30, 50) # switch 30 to 29.8 to keep extra site in
```

Import map of distances from the coast, and use to make masks to distinguish land and water areas ([source](http://worldgrids.org/doku.php/wiki:dicgsh1)).
```{r}
distance_coast <- raster('data/DICGSH1a.tif') %>% # import the map
  crop(bbox) %>% # crop to the study area
  reclassify(c(-Inf, 0, 0))

land_sea <-  distance_coast %>%
  reclassify(c(-Inf, Inf, 1)) 

land_mask <- distance_coast %>%
  reclassify(c(0, Inf, 0, -Inf, 0, 1)) # pure water to 0, all else to 1
```

```{r echo = F}
land_mask %>%
  as.data.frame(xy = T, na.rm = T) %>%
  ggplot(aes(x, y, fill = layer)) +
    geom_raster() +
    ggtitle('Land-sea mask', 'Source: Worldgrids.org') +
    coord_quickmap() +
    theme_void()
```


Import the database of 14C dates from neolithic sites.
```{r message = F}
dates <- read_csv('data/cs_dates_4_grass.csv') %>%
  filter(Long != 0) %>% # get rid of erroneous entry
  select(Site_Name, Long, Lat, Cal.BC, Cal.BC.SD) # select just the variables we'll need
```


```{r echo = }
load('data//med_region_gg.rda')

ggplot(dates, aes(Long, Lat)) +
  geom_point(aes(color = Cal.BC)) +
  geom_path(data = med_region_gg, aes(long,lat, group = group)) +
  scale_color_distiller(palette = 'RdYlBu') +
  coord_quickmap(xlim = c(-9.9, 45), ylim = c(29.8, 50)) +
  labs(title = 'Neolithic spread', subtitle = 'Initial site occupation') +
  theme_void()
```


## Least cost distance modeling
First let's use the **gdistance** package to calculate how far all the sites in our database are from Jericho (which we use as the "first" site).




Start by generating a few simple transition matrices using different basemaps. We'll start with three purely geographic transition layers:
1. Euclidean distance: calculate raw great circle euclidean distances from the starting point.
2. Distance along land masses.
3. Land and coast: distance across land + sea cells less than 40km away from the coast.

Euclidean distances
```{r}
con_landsea <- transition(land_sea, max, 16)
```

Generate a simple conductance matrix, where all land-land connections are set to 1 and all land-sea or sea-sea connections are set to 0.
```{r}
con_land <- transition(land_mask, min, 16)
```

That last coastal map may be too simplistic. Let's calculate a continuous decay function as distance from the coast increases. Define a function to do this after Van Etten and Hijmans 2011
```{r}
decay <- function(x, p){
	tm <- transitionMatrix(x)
	tm@x[tm@x>0.1] <- (2^-(tm@x[tm@x>0.1]/p))
	tm@x <- tm@x/max(tm@x)
	transitionMatrix(x) <- tm
	return(x)
}
```

```{r}
coastal_decay <- distance_coast %>%
  transition(mean, directions = 16)

coastal_decay <- c(10, 20, 40, 80) %>%
  map(~ decay(coastal_decay, .))
```

```{r}
coastal_decay %>%
  map(raster) %>%
  brick %>%
  `names<-`(c(10, 20, 40, 80)) %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  gather(key = decay_constant, value, 3:6) %>%
  ggplot(aes(x, y)) +
    geom_raster(aes(fill = value)) +
    facet_wrap(~decay_constant) +
    scale_fill_distiller(palette = 'PuBuGn', direction = 1) +
    ggtitle('Distance decay for coastal travel') +
    coord_quickmap() +
    theme_void()
```

Calculate intercell distances for later correction of conductance matrices.
```{r}
correction_lcp <- geoCorrection(con_landsea, type = 'c', multpl = T)
```
## Crop Model Outputs

Import the results of the DSSAT simulations. Create a raster brick.
```{r}
yields_rast <- list.files('data/paleoD_10nov16/paleoD3p1_monthlyyieldonly/whemmer', 
                      pattern = '*ensemble*',
                      full.names = T) %>%
  map(raster) %>%
  brick %>%
  reclassify(c(-Inf, 0, 0, NA, NA, 0)) %>%
  mask(., land_mask, maskvalue = 0) %>%
  `names<-`(month.name) %>%
  `projection<-`('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
```

Convert rasters to a data frame, adding in seasonal information.
```{r}
yields <- yields_rast %>% as.data.frame(xy = T, na.rm = T) %>%
  gather(month, yield, 3:14) %>%
  mutate(month = factor(month, levels = month.name),
         season = case_when(month %in% month.name[c(12, 1, 2)] ~ 'Winter', 
                            month %in% month.name[3:5] ~ 'Spring',
                            month %in% month.name[6:8] ~ 'Summer',
                            month %in% month.name[9:11] ~ 'Fall'),
         season = factor(season, levels = c('Winter', 'Spring', 'Summer', 'Fall')))
```

```{r eval=F, echo = F}
ggplot(yields, aes(x, y, fill = yield)) +
  geom_raster() +
  scale_fill_viridis() +
  facet_wrap(~month) +
  coord_quickmap() +
  ggtitle('Mean wheat yields by planting month') +
  theme_void()
```

```{r echo = F}
yields %>%
  group_by(x, y, season) %>%
  filter(yield == max(yield)) %>%
ggplot(aes(x, y)) +
  geom_raster(aes(fill = yield)) +
  scale_fill_viridis() +
  facet_wrap(~season) +
  ggtitle('Maximum wheat yields by planting season') +
  coord_quickmap() +
  theme_void()
```


```{r echo = F}
yields %>%
  group_by(x, y) %>%
  filter(yield == max(yield)) %>%
  filter(yield > 0) %>%
ggplot(aes(x, y)) +
  geom_raster(aes(fill = season, alpha = yield)) +
  geom_point(data = dates, aes(Long, Lat)) +
  geom_path(data = med_region_gg, aes(long,lat, group = group)) +
  scale_fill_manual(values = c('#2b83ba', '#abdda4', '#d7191c', '#fdae61')) +
  coord_quickmap(xlim = c(-9.9, 45), ylim = c(30, 50)) +
  ggtitle('Best planting seasons') +
  theme_void()
```

```{r eval = F}
vid <- ggplot(dat, aes(Long, Lat)) +
  geom_raster(data = best.month, aes(x, y, fill = Month, alpha = Yield)) +
  geom_point(aes(frame = Cal.BC * -1, cumulative = T)) +
    geom_path(data = med_region_gg, aes(long,lat, group = group)) +
  scale_fill_manual(values = c('#2b83ba', '#abdda4', '#d7191c', '#fdae61')) +
  coord_quickmap(xlim = c(-9.9, 45), ylim = c(30, 50)) +
  labs(title = 'Neolithic spread', subtitle = 'Initial site occupations over wheat planting season and yield') +
  theme_void()

gganimate(vid, filename = 'neo_spread.mp4', saver = 'mp4')
```

### Crop model costs
Now use the yield data to calculate new conductance matrices that reflect variable crop yields. Define a function that represents the relative costs of moving from a cell with optimal plantint date in one month to a a cell with another optimal planting date. Use the "weight" parameter to determine the steepness of this function.

```{r}
month_fun <- function(x){
  dist <- 6 - abs(abs(x[1] - x[2]) - 6) # distance in months
  return(exp(- 1 * dist^2))
}
```

```{r echo = F}
expand.grid(difference = seq(0,6,.1), weight = seq(.1,1,.1)) %>%
  mutate(test = exp(- weight * difference^2)) %>%
  ggplot(aes(difference, test, group = weight, color = weight)) +
  labs(x = 'Difference in optimal planting months', y = 'Conductance',
       title = 'Functions') +
  geom_line() +
    theme_minimal()
```
Use this function to calculate a transitionlayer.
```{r}
con_month <- which.max(yields_rast) %>%
  transition(month_fun, direction = 16)
```

## Cost Distances
Find the location of Jericho to use as a starting point. 
```{r}
jericho <- dates %>%
  filter(Site_Name == 'Jericho') %>%
  select(Long:Lat) %>%
  as.matrix
```

Calculate the least cost distances from Jericho for each of the conductance layers, correcting for intercell distances.
```{r}
distances <- c(con_landsea,
               con_land,
               con_month,
               map(coastal_decay, ~. + con_land),
               map(coastal_decay, ~. + con_month)) %>%
  map(~ . * correction_lcp) %>%
  map(accCost, fromCoords = jericho) %>%
  brick
```

```{r echo = F}
distances %>%
  mask(land_mask, maskvalue = 0) %>%
  as.data.frame(xy = T, na.rm =T) %>%
  #rename(euc = layer.1, land = layer.2, landsea = layer.3, month_only = layer.4, month_sea = layer.5) %>%
  gather(type, cost, 3:13) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = cost)) +
  facet_wrap(~type, nrow = 3) +
  scale_fill_viridis(direction = -1) +
  coord_quickmap() +
  theme_void()
```


Add the results to the sites data. (Why does raster:extract result in some na's and infs? something to do with the land sea boundary?)
```{r}
costs <- dates %>%
  select(Long:Lat) %>%
  as.matrix %>%
  raster::extract(distances, ., df = T) %>%
  #rename(euc = layer.1, land = layer.2, landsea = layer.3, month_land = layer.4, month_sea = layer.5) %>%
  cbind(dates, .) %>%
  select(-ID) %>%
  gather(type, cost, 6:16) %>%
  nest(-type) %>%
  mutate(data = map(data, ~filter(., is.finite(cost)))) %>%
  mutate(data = map(data, ~filter(., cost < 1e10))) # shouldnt have to do this!
```


```{r}
quantile_gam <- function(df){
  qgam(list(
    Cal.BC ~ s(cost, bs = 'cr'), 
           ~ s(cost, bs = 'cr')), 
    data = df,
    qu = 0.85)
}

make_preds <- function(x){
  predict(x, type = 'response', se = T) %>%
  map(~.[,1]) %>%
  bind_cols %>%
  mutate(upper = fit + 2 * se.fit,
         lower = fit - 2 * se.fit)
}
```

```{r}
test <- costs$data[[1]]
plot(qgam(Cal.BC ~ s(cost, bs = 'cr') + te(Long, Lat),
     data = test,
     qu = .95))
```

```{r}
fits <- costs %>%
  mutate(mod = map(data, quantile_gam),
         aic = map_dbl(mod, 'aic'),
         preds = map(mod, make_preds))
fits
```


```{r}
plot_results <- function(x){
  print(ggplot(x, aes(cost, Cal.BC)) +
  geom_pointrange(aes(ymin = Cal.BC - Cal.BC.SD, 
                      ymax = Cal.BC + Cal.BC.SD,  
                      alpha = (1 / Cal.BC.SD) ^ 2), fatten = 2) +
  geom_line(aes(y = fit), color = 'red') +
  geom_line(aes(y = lower), linetype = 2, color = 'red') +
  geom_line(aes(y = upper), linetype = 2, color = 'red') +
  xlim(0, 5.5e6) +
  theme_bw())
}


map2(fits$data, fits$preds, bind_cols) %>%
  walk(plot_results)
```

```{r eval=FALSE, include=FALSE}
mod <- gam(Cal.BC ~ s(cost, bs = 'cr'), 
            data = costs$data[[3]],
            weights = (1/costs$data[[3]]$Cal.BC.SD)^2)
mod2<- gam(Cal.BC ~ s(cost, bs = 'cr'), 
            data = costs)
mod3 <- gam(Cal.BC ~ s(cost, bs = 'cr'), 
            data = costs,
            weights = (1/costs$Cal.BC.SD)^2 / mean((1/costs$Cal.BC.SD)^2))
plot(mod);plot(mod2); plot(mod3)
```

```{r}
test <- cbind(costs$data[[5]], pred = fits$preds[[5]]$fit) %>%
  mutate(resid = Cal.BC - pred) %>%
  filter(resid > 0)

yields %>%
  group_by(x, y) %>%
  filter(yield == max(yield)) %>%
  filter(yield >= 0) %>%
ggplot(aes(x, y)) +
  geom_raster(aes(fill = season, alpha = yield)) +
  geom_point(data = test, aes(Long, Lat, color = resid), size = 3) +
  geom_path(data = med_region_gg, aes(long,lat, group = group)) +
  scale_color_distiller(palette = 'RdYlBu') +
  coord_quickmap(xlim = c(-9.9, 45), ylim = c(30, 50)) +
  scale_fill_manual(values = c('#2b83ba', '#abdda4', '#d7191c', '#fdae61')) +
  labs(title = 'Neolithic spread', subtitle = 'Initial site occupation') +
  theme_void()

which.max(yields_rast) %>%
  as.data.frame(xy = T, na.rm = T) %>%
ggplot(aes(x, y)) +
  geom_raster(aes(fill = as.factor(layer))) +
  geom_point(data = test, aes(Long, Lat, color = resid), size = 3) +
  geom_path(data = med_region_gg, aes(long,lat, group = group)) +
  scale_color_distiller(palette = 'RdYlBu') +
  coord_quickmap(xlim = c(-9.9, 45), ylim = c(30, 50)) +
  labs(title = 'Neolithic spread', subtitle = 'Initial site occupation') +
  theme_void()
```



```{r eval = F}
library(tidygraph)
library(ggraph)

commuteDistance(con_landsea_r, pts)
net <- as_tbl_graph(out) %>%
  mutate(date = dat$Cal.BC, x = dat$Long, y = dat$Lat, resids = mod1$residuals) %>%
  activate(edges) %>%
  mutate(time_diff = .N()$date[from] - .N()$date[to]) %>%
  mutate(med_date = (.N()$date[from] + .N()$date[to]) / 2)


net %>%
  filter(time_diff > 0 & time_diff <= 65) %>%
  filter(weight <= 600000) %>%
ggraph() +
  geom_edge_fan(alpha = .2) +
  geom_node_point(aes(color = date)) +
  scale_color_distiller(palette = 'Spectral', direction = -1) +
  theme_void() +
  geom_path(data = med_region_gg, aes(long,lat, group = group)) +
  coord_quickmap(xlim = c(-9.9, 45), ylim = c(30, 50))
```

```{r eval = F}
dat2 %>%
  mutate(arrival = if_else(residuals <= 0, 'Late', 'Early')) %>%
ggplot(aes(Long, Lat)) +
  geom_raster(data = best.month, aes(x, y, fill = Month, alpha = Yield)) +
  geom_point(aes(color = arrival)) +
    geom_path(data = med_region_gg, aes(long,lat, group = group)) +
  scale_fill_manual(values = c('#2b83ba', '#abdda4', '#d7191c', '#fdae61')) +
  coord_quickmap(xlim = c(-9.9, 45), ylim = c(30, 50)) +
  labs(title = 'Neolithic spread', subtitle = 'Initial site occupations over wheat planting season and yield') +
  theme_void()
```